rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get the current user's UID
    function currentUid() {
      return request.auth.uid;
    }
    
    // Check if user is a member of a trip
    function isMemberOfTrip(tripId) {
      return exists(/databases/$(database)/documents/trips/$(tripId)/members/$(request.auth.uid))
        || memberExistsByUid(tripId, request.auth.uid);
    }
    
    // Check if a member document with the given UID exists
    function memberExistsByUid(tripId, uid) {
      return getAfter(/databases/$(database)/documents/trips/$(tripId)).data.ownerUid == uid;
    }
    
    // Check if user is the owner of a trip
    function isTripOwner(tripId) {
      return get(/databases/$(database)/documents/trips/$(tripId)).data.ownerUid == currentUid();
    }
    
    // ============================================================
    // USERS COLLECTION (User Profiles)
    // ============================================================
    
    match /users/{userId} {
      // Any authenticated user can read profiles (needed for member name display)
      allow read: if isAuthenticated();
      // Users can only write their own profile
      allow write: if isAuthenticated() && currentUid() == userId;
    }
    
    // ============================================================
    // TRIPS COLLECTION
    // ============================================================
    
    match /trips/{tripId} {
      // Anyone authenticated can create a trip
      allow create: if isAuthenticated()
        && request.resource.data.ownerUid == currentUid()
        && request.resource.data.keys().hasAll(['title', 'currency', 'ownerUid', 'inviteCode', 'inviteCodeActive', 'inviteCodeCreatedAt', 'createdAt']);
      
      // Members can read the trip
      allow read: if isAuthenticated();
      
      // Owner can update the trip, OR members can update only the updatedAt field
      allow update: if isAuthenticated() 
        && (
          // Owner can update anything (except ownerUid)
          (isTripOwner(tripId) && request.resource.data.ownerUid == resource.data.ownerUid)
          // Or any authenticated user can update only updatedAt (for join triggering stream)
          || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['updatedAt']))
        );
      
      // Only owner can delete
      allow delete: if isAuthenticated() && isTripOwner(tripId);
      
      // ============================================================
      // MEMBERS SUBCOLLECTION
      // ============================================================
      
      match /members/{memberId} {
        // Anyone authenticated can read members (needed for join flow)
        allow read: if isAuthenticated();
        
        // Member creation rules:
        // 1. User adding themselves (with uid) - join flow or owner self-add
        // 2. Trip owner adding manual member (without uid, with manualName)
        allow create: if isAuthenticated()
          && request.resource.data.keys().hasAll(['createdAt'])
          && (
            // User is adding themselves (linked member)
            (request.resource.data.uid == currentUid())
            // Or trip owner is adding a manual member
            || (
              get(/databases/$(database)/documents/trips/$(tripId)).data.ownerUid == currentUid()
              && !('uid' in request.resource.data) 
              && 'manualName' in request.resource.data
            )
          );
        
        // Owner or the member themselves can update
        allow update: if isAuthenticated()
          && (isTripOwner(tripId) || resource.data.uid == currentUid());
        
        // Owner or the member themselves can delete
        allow delete: if isAuthenticated()
          && (isTripOwner(tripId) || resource.data.uid == currentUid());
      }
      
      // ============================================================
      // EXPENSES SUBCOLLECTION
      // ============================================================
      
      match /expenses/{expenseId} {
        // Members can read expenses
        allow read: if isAuthenticated();
        
        // Members can create expenses
        allow create: if isAuthenticated()
          && request.resource.data.createdByUid == currentUid()
          && request.resource.data.keys().hasAll([
            'amount_cents', 
            'description', 
            'payer_member_id', 
            'participant_member_ids', 
            'createdByUid', 
            'createdAt'
          ]);
        
        // Creator or owner can update
        allow update: if isAuthenticated()
          && (resource.data.createdByUid == currentUid() || isTripOwner(tripId));
        
        // Creator or owner can delete
        allow delete: if isAuthenticated()
          && (resource.data.createdByUid == currentUid() || isTripOwner(tripId));
      }
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
